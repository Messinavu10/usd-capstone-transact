<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" status="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/style.css" />
    <title>Verifier</title>
  </head>

  <body>
    <%- include('includes/navbar', {isAuthenticated: isAuthenticated,
    configured, list, query, presentationRequest}); %> <%-
    include('includes/footer'); %> <% const club = list.filter((item) => {
    return item.id === query.credType; }); %> <%- console.log(club.length===0);
    %>

    <div
      class="d-flex flex-column justify-content-center align-items-center mt-1"
    >
      <% if (club.length!==0) { %>

      <div class="d-flex justify-content-center align-items-center">
        <img
          src="<% __append(club[0].image)%>"
          alt="<% __append(club[0].imagealt)%>"
          class="img-fluid mr-3"
          style="width: 80px"
        />
        <h1><% __append(club[0].name)%></h1>
      </div>

      <h2 class="mt-4 mb-4">
        Use your Microsoft Authenticator App to scan to verify your identity
      </h2>
      <div class="border border-white rounded-lg p-3 bg-light mt-2">
        <div id="qrcode" style="text-align: center"></div>
      </div>

      <% } else { %>
      <h1 class="mt-4 mb-4">Please sign in first</h1>

      <% } %>

      <a class="btn btn-primary mt-2" href="/verifier">Go Back</a>
    </div>

    <div id="message-wrapper" style="text-align: center; display: none">
      <div id="message"></div>
      <br />
      <div id="subject"></div>
      <br />
      <div id="payload"></div>
    </div>

    <!-- importing bootstrap.js and supporting js libraries -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="qrcode.min.js"></script>
    <script>
      //   var signIn = document.getElementById("sign-in");
      //   var signOut = document.getElementById("sign-out");
      //   var display = document.getElementById("display");
      var qrcode = new QRCode("qrcode", { width: 300, height: 300 });
      // for now use a dummy url for testing
      qrcode.makeCode("<% __append(presentationRequest.url)%>");

      checkIssuanceResponse();

      function displayMessage(msg) {
        document.getElementById("message-wrapper").style.display = "block";
        document.getElementById("message").innerHTML = msg;
      }

      function checkIssuanceResponse() {
        var checkStatus = setInterval(function () {
          fetch("verifier-response?id=<% __append(sessionId)%>") // This should be the session id
            .then((response) => response.text())
            .catch((error) => displayMessage(error))
            .then((response) => {
              if (response.length > 0) {
                console.log(response);
                respMsg = JSON.parse(response);
                // QR Code scanned, make it less visible
                if (respMsg.status == "request_retrieved") {
                  document
                    .getElementById("qrcode")
                    .getElementsByTagName("img")[0].style.opacity = "0.1";
                  document.getElementById("qrText").style.display = "none";
                  displayMessage(respMsg.message);
                }
                if (respMsg.status == "presentation_verified") {
                  document.getElementById("qrcode").style.display = "none";
                  document.getElementById("message").innerHTML =
                    respMsg.message;
                  document.getElementById("payload").innerHTML =
                    "Payload: " + JSON.stringify(respMsg.payload[0].claims);
                  document.getElementById("subject").innerHTML =
                    "Please Verify";
                  clearInterval(checkStatus);
                }
                if (respMsg.status == "issuance_failed") {
                  document.getElementById("qrcode").style.display = "none";
                  document.getElementById("message").innerHTML =
                    "Presentation error occurred";
                  document.getElementById("payload").innerHTML =
                    "Payload: " + respMsg.payload;
                  clearInterval(checkStatus);
                }
              }
            });
        }, 5500);
      }
    </script>
  </body>
</html>
